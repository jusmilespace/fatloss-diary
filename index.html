<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ju Smile æ¸›è„‚æ—¥èªŒ</title>
  <meta name="theme-color" content="#97d0ba" />
  <link rel="manifest" href="manifest.json?v=20251101-4" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <link rel="icon" href="icon-192.png" sizes="192x192" />
  <link rel="stylesheet" href="styles.css?v=20251101-4" />
  <style>
    :root{--mint:#97d0ba;--border:#e9ecef}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.45;background:#f7faf9;color:#213}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:16px;margin:14px 0}
    .row3,.row4{display:grid;gap:12px}
    .row3{grid-template-columns:1fr 1fr 1fr}
    .row4{grid-template-columns:1fr 1fr 1fr 1fr}
    label{display:block;margin:2px 0 6px;font-weight:600;color:#334}
    input,select,button{width:100%;padding:10px;border:1px solid #dfe3e6;border-radius:10px;background:#fff}
    button{cursor:pointer}
    .btn-primary{background:var(--mint);color:#fff;border:1px solid rgba(0,0,0,.05)}
    .btn-ghost{background:#eef6f3;color:#0d4a3c;border:1px solid #cfe8df}
    .btn-danger{background:#fdeaea;color:#a33a3a;border:1px solid #f4cfcf}
    .muted{color:#667; font-size:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;border-bottom:1px solid #eef2f4;text-align:left;vertical-align:top}
    .progress{height:28px;background:#eef6f3;border-radius:12px;overflow:hidden}
    .bar{height:100%;background:var(--mint);color:#fff;display:flex;align-items:center;justify-content:center;white-space:nowrap}
    .typeahead{position:relative}
    .typeahead-panel{position:absolute;inset:auto 0 0 0;transform:translateY(100%);background:#fff;border:1px solid #e7ecef;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.06);max-height:240px;overflow:auto;z-index:30}
    .typeahead-item{display:flex;justify-content:space-between;gap:8px;padding:8px 10px;cursor:pointer}
    .typeahead-item:hover,.typeahead-item.active{background:#f3faf7}
    .typeahead-mark{background:#fffdc7}
    .tag{font-size:12px;color:#0d4a3c;opacity:.7}
    dialog.card{border:0;border-radius:14px;padding:18px 20px}
    dialog::backdrop{background:rgba(0,0,0,.25)}
    details summary{cursor:pointer;color:#0d4a3c}
    details{background:#f6fbf9;border:1px dashed #cfe8df;border-radius:10px;padding:8px 10px}
    .note{font-size:12px;color:#456}

    /* --- RWD æ–·é»ï¼šé¿å…æ¬„ä½æ“ åœ¨ä¸€èµ· --- */
    @media (max-width: 1100px){
      .row4 { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 820px){
      .row3 { grid-template-columns: 1fr 1fr; }
      .row4 { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 640px){
      .row3, .row4 { grid-template-columns: 1fr; }
    }
    /* ä»Šæ—¥æ¦‚æ³è† å›Š */
.summary-row{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
.pill{border:1px solid #dfe3e6;border-radius:999px;padding:10px 14px;
  background:#f6fbf9;color:#214;display:inline-flex;gap:6px;align-items:center}
.pill b{font-weight:800;letter-spacing:0.5px}
.pill.kcal{border-color:#cfe8df}
.pill.pro{border-color:#cfe8df}
.pill.carb{border-color:#cfe8df}
.pill.fat{border-color:#cfe8df}
.pill.ex{border-color:#cfe0ff;background:#f7f9ff}
.pill.net{border-color:#f8e3c2;background:#fff9f0}
.alert-text{margin-top:6px;color:#993c00;font-weight:600}
.alert-text.ok{color:#0d4a3c;font-weight:500}

  </style>
</head>
<body>
<div class="wrap">

  <header class="card">
    <h1>Ju Smile æ¸›è„‚æ—¥èªŒ <small id="appVer" class="muted"></small></h1>
    <div class="row4">
      <div>
        <label>æ¯æ—¥ç†±é‡ç›®æ¨™</label>
        <input id="setCal" type="number" placeholder="ä¾‹ï¼š1300" />
      </div>
      <div>
        <label>æ¯æ—¥è›‹ç™½è³ªç›®æ¨™ (g)</label>
        <input id="setProtein" type="number" placeholder="ä¾‹ï¼š160" />
      </div>
      <div>
        <label>ç›®å‰é«”é‡ (kg)</label>
        <input id="setWeight" type="number" step="0.1" placeholder="ä¾‹ï¼š70" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnSaveTargets" class="btn-primary">å„²å­˜ç›®æ¨™/é«”é‡</button>
      </div>
    </div>
    <hr style="border:none;border-top:1px solid #eef2f4;margin:12px 0">

<h3 style="margin:0 0 6px">ä»Šæ—¥æ¦‚æ³</h3>
<div class="summary-row">
  <div class="pill kcal">æ”å–ï¼š<b id="sumKcalBadge">0</b> kcal</div>
  <div class="pill pro">è›‹ç™½ï¼š<b id="sumPBadge">0</b> g</div>
  <div class="pill carb">ç¢³æ°´ï¼š<b id="sumCBadge">0</b> g</div>
  <div class="pill fat">è„‚è‚ªï¼š<b id="sumFBadge">0</b> g</div>
  <div class="pill ex">é‹å‹•æ¶ˆè€—ï¼š<b id="exKcalBadge">0</b> kcal</div>
  <div class="pill net">æ·¨ç†±é‡ï¼š<b id="netKcalBadge">0</b> kcal</div>
</div>

<div id="badgeAlerts" class="alert-text"></div>

  </header>

  <section class="card">
    <h2>é£²é£Ÿç´€éŒ„ï¼ˆä¸‰ç¨®è¼¸å…¥ä»»é¸ï¼‰</h2>

    <!-- é¤åˆ¥ -->
    <div class="row3">
      <div>
        <label>é¤åˆ¥</label>
        <select id="foodMeal">
          <option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option>
          <option>é»å¿ƒ</option><option>å®µå¤œ</option>
        </select>
      </div>
      <div></div><div></div>
    </div>

    <!-- åç¨± / æ•¸é‡ / å–®ä½ -->
    <div class="row3">
      <div>
        <label>é£Ÿç‰©åç¨±ï¼ˆæ”¯æ´æœå°‹/åˆ¥åï¼‰</label>
        <div class="typeahead">
          <input id="foodName" class="typeahead-input" placeholder="æœå°‹ï¼šç™½é£¯ / é›è…¿ä¾¿ç•¶ / è±†æ¼¿â€¦" />
          <div id="foodSuggest" class="typeahead-panel" hidden></div>
        </div>
        <small class="muted">è¼¸å…¥é—œéµå­—æœƒå‡ºç¾å»ºè­°ï¼›â†‘â†“ç§»å‹•ã€Enteré¸å–</small>
      </div>
      <div>
        <label>æ•¸é‡</label>
        <input id="foodQty" type="number" inputmode="decimal" step="0.1" value="1" />
        <small class="muted">å¯ 0.5 / 1 / 2â€¦ï¼ˆå€ç‡ï¼‰</small>
      </div>
      <div>
        <label>å–®ä½</label>
        <select id="foodUnit">
          <option value="">é¸æ“‡å–®ä½</option>
          <option value="g">gï¼ˆå…¬å…‹ï¼‰</option>
          <option value="ml">mlï¼ˆæ¯«å‡ï¼‰</option>
          <option value="å€‹">å€‹</option>
          <option value="ç¢—">ç¢—</option>
          <option value="ç‰‡">ç‰‡</option>
          <option value="æ¹¯åŒ™">æ¹¯åŒ™</option>
          <option value="å¼µ">å¼µ</option>
          <option value="ç²’">ç²’</option>
          <option value="æ¯">æ¯</option>
        </select>
        <small id="unitHint" class="muted">è¼¸å…¥åç¨±è‹¥åŒ¹é…è³‡æ–™åº«ï¼Œæœƒè‡ªå‹•å¸¶å‡ºå¯ç”¨å–®ä½ä¸¦æ›ç®—ä»½é‡</small>
      </div>
    </div>

    <!-- Type Ã— è¨ˆç®—ä»½é‡ + é‡æ–°è¨ˆç®— -->
    <div class="row3">
      <div>
        <label>é¡åˆ¥ Type</label>
        <select id="foodType">
          <option value="">ï¼ˆå¯ä¸é¸ï¼‰</option>
          <option>å…¨ç©€é›œç³§é¡</option>
          <option>è±†é­šè›‹è‚‰é¡ï¼ˆä½è„‚ï¼‰</option>
          <option>è±†é­šè›‹è‚‰é¡ï¼ˆä¸­è„‚ï¼‰</option>
          <option>è±†é­šè›‹è‚‰é¡ï¼ˆé«˜è„‚ï¼‰</option>
          <option>ä¹³å“é¡ï¼ˆå…¨è„‚ï¼‰</option>
          <option>ä¹³å“é¡ï¼ˆä½è„‚ï¼‰</option>
          <option>ä¹³å“é¡ï¼ˆè„«è„‚ï¼‰</option>
          <option>è”¬èœé¡</option>
          <option>æ°´æœé¡</option>
          <option>æ²¹è„‚èˆ‡å …æœç¨®å­é¡</option>
          <option>ç”œé»é£²æ–™ï¼ˆç³–ï¼‰</option>
          <option>æ‰‹æ–é£²ï¼ˆå¥¶èŒ¶åŸºæº–ï¼‰</option>
          <option>æ··åˆæ–™ç†ï¼ˆä¾¿ç•¶å°æ ¼ï¼‰</option>
        </select>
      </div>
      <div>
        <label>è¨ˆç®—ä»½é‡</label>
        <input id="foodServings" type="number" step="0.1" placeholder="ä¾‹ï¼š1.5" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnAutoFill" class="btn-ghost" title="è‹¥æ•¸å€¼æœªè‡ªå‹•æ›´æ–°ï¼Œå¯æ‰‹å‹•é‡æ–°è¨ˆç®—">é‡æ–°è¨ˆç®— ğŸ”„</button>
      </div>
    </div>

    <!-- K / P / C / F -->
    <div class="row4">
      <div><label>kcal</label><input id="foodKcal" type="number" /></div>
      <div><label>è›‹ç™½è³ª (g)</label><input id="foodProtein" type="number" /></div>
      <div><label>ç¢³æ°´ (g)</label><input id="foodCarb" type="number" /></div>
      <div><label>è„‚è‚ª (g)</label><input id="foodFat" type="number" /></div>
    </div>

    <div class="row3" style="margin-top:10px">
      <button id="btnAddFood" class="btn-primary">åŠ å…¥ä»Šæ—¥ç´€éŒ„</button>
      <button id="btnClearFoods" class="btn-danger">æ¸…ç©ºä»Šå¤©é£²é£Ÿ</button>
      <div></div>
    </div>

    <!-- æ˜ç´°ï¼šå«å‹¾é¸/å…¨é¸ -->
    <table class="table" style="margin-top:10px">
      <thead>
        <tr>
          <th><input id="chkAllFoods" type="checkbox" title="å…¨é¸/å…¨ä¸é¸" /></th>
          <th>é¤åˆ¥</th><th>åç¨±</th><th>æ•¸é‡</th><th>å–®ä½</th>
          <th>kcal</th><th>è›‹ç™½è³ª</th><th>ç¢³æ°´</th><th>è„‚è‚ª</th><th></th>
        </tr>
      </thead>
      <tbody id="foodTable"></tbody>
    </table>

    <!-- ç”¨å‹¾é¸å»ºç«‹å¸¸ç”¨çµ„åˆ + å¿«é€ŸåŠ å…¥ -->
    <div class="row3" style="margin-top:10px">
      <div>
        <label>ç”¨ã€Œå‹¾é¸çš„å“é …ã€å­˜æˆå¸¸ç”¨çµ„åˆ</label>
        <input id="presetFromSelectedName" placeholder="ä¾‹ï¼šæˆ‘çš„æ—©é¤A" />
      </div>
      <div style="align-self:end">
        <button id="btnSavePresetFromSelected" class="btn-primary" style="width:100%">å„²å­˜ç‚ºå¸¸ç”¨çµ„åˆ</button>
      </div>
      <div>
        <label>å¾å¸¸ç”¨çµ„åˆå¿«é€ŸåŠ å…¥</label>
        <div style="display:flex;gap:8px">
          <select id="quickPresetSelect" style="flex:1"></select>
          <button id="btnQuickAddPreset" class="btn-ghost">åŠ å…¥</button>
          <button id="btnEditSelectedPreset" class="btn-ghost" title="ç·¨è¼¯ä¸‹æ‹‰é¸ä¸­çš„å¸¸ç”¨çµ„åˆ">ç®¡ç†/ç·¨è¼¯</button>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>é‹å‹•ç´€éŒ„</h2>
    <div class="row4">
      <div>
        <label>é‹å‹•åç¨±</label>
        <input id="exName" list="exList" placeholder="ä¾‹ï¼šå¿«èµ° / é‡è¨“ / æ¸¸æ³³â€¦" />
        <datalist id="exList"></datalist>
      </div>
      <div>
        <label>METï¼ˆä»£è¬ç•¶é‡ï¼‰</label>
        <input id="exMET" type="number" step="0.1" placeholder="ä¾‹ï¼šå¿«èµ° 3.5ã€æ…¢è·‘ 7" />
        <small class="muted">åç¨±ä¸åœ¨æ¸…å–®ä¹Ÿå¯ç›´æ¥è¼¸å…¥ MET å¾ŒåŠ å…¥</small>
        <details style="margin-top:6px">
          <summary>äº†è§£ MET æ˜¯ä»€éº¼ï¼Ÿï¼ˆé»æˆ‘å±•é–‹ï¼‰</summary>
          <div class="note" style="margin-top:6px">
            <div><b>ç†±é‡ï¼ˆkcalï¼‰= MET Ã— 3.5 Ã— é«”é‡(kg) Ã· 200 Ã— æ™‚é–“(åˆ†é˜)</b></div>
            <div style="margin:6px 0">å¸¸è¦‹åƒè€ƒï¼šå¥èµ° 3.5ã€é‡è¨“ 6ã€æ…¢è·‘ 7ã€æ¸¸æ³³(ä¸­é€Ÿ) 8.3ã€ç™»å±± 9ã€è·³ç¹©(å¿«) 12ã€‚</div>
            <table class="table">
              <thead><tr><th>æ´»å‹•</th><th>MET</th><th>å‚™è¨»</th></tr></thead>
              <tbody>
                <tr><td>åè‘—ä¸å‹•</td><td>1.0</td><td>ä¼‘æ¯</td></tr>
                <tr><td>å¥èµ°ï¼ˆç´„4km/hï¼‰</td><td>3.5</td><td>è¼•åº¦</td></tr>
                <tr><td>é‡è¨“ï¼ˆå…¨èº«ï¼‰</td><td>6.0</td><td>ä¸­ç­‰å¼·åº¦</td></tr>
                <tr><td>æ…¢è·‘ï¼ˆ8km/hï¼‰</td><td>7.0</td><td>ä¸€èˆ¬è·‘æ­¥</td></tr>
                <tr><td>æ¸¸æ³³ï¼ˆè‡ªç”±å¼ä¸­é€Ÿï¼‰</td><td>8.3</td><td>ä¸­å¼·åº¦</td></tr>
                <tr><td>ç™»å±±å¥è¡Œ</td><td>9.0</td><td>å«ä¸Šå¡</td></tr>
                <tr><td>è·³ç¹©ï¼ˆå¿«ï¼‰</td><td>12.0</td><td>é«˜å¼·åº¦</td></tr>
              </tbody>
            </table>
          </div>
        </details>
      </div>
      <div>
        <label>åˆ†é˜</label>
        <input id="exMins" type="number" value="30" />
      </div>
      <div>
        <label>é«”é‡ (kg)</label>
        <input id="userWeight" type="number" step="0.1" placeholder="é è¨­ç”¨ä¸Šæ–¹é«”é‡" />
      </div>
    </div>
    <div class="row3" style="margin-top:10px">
      <button id="btnAddEx" class="btn-primary">åŠ å…¥é‹å‹•</button>
      <button id="btnClearExToday" class="btn-danger">æ¸…ç©ºä»Šå¤©é‹å‹•</button>
      <div></div>
    </div>

    <table class="table" style="margin-top:10px">
      <thead><tr><th>åç¨±</th><th>MET</th><th>åˆ†é˜</th><th>kcal</th><th></th></tr></thead>
      <tbody id="exTable"></tbody>
    </table>
  </section>

  <section class="card">
    <h2>ä»Šæ—¥çµ±è¨ˆ</h2>
    <div class="row4">
      <div><label>æ”å…¥ kcal</label><div id="sumKcal">0</div></div>
      <div><label>é‹å‹•æ¶ˆè€— kcal</label><div id="exKcal">0</div></div>
      <div><label>æ·¨ç†±é‡ kcal</label><div id="netKcal">0</div></div>
      <div></div>
    </div>
    <div class="progress" style="margin-top:10px"><div class="bar" id="calBar" style="width:0%">0/0 kcal</div></div>
  </section>

  <!-- çµ„åˆç·¨è¼¯ dialogï¼ˆä¿ç•™ï¼‰ -->
  <dialog id="presetEditor" class="card" style="max-width:720px;width:90%">
    <h3 id="peTitle">ç·¨è¼¯çµ„åˆ</h3>
    <table class="table">
      <thead><tr><th>#</th><th>åç¨±</th><th>kcal</th><th>è›‹ç™½è³ª</th><th>ç¢³æ°´</th><th>è„‚è‚ª</th><th></th></tr></thead>
      <tbody id="peBody"></tbody>
    </table>
    <div class="row3">
      <button id="peClose" class="btn-ghost">é—œé–‰</button>
      <button id="peSave" class="btn-primary">å„²å­˜è®Šæ›´</button>
      <button id="peDelete" class="btn-danger">åˆªé™¤æ•´å€‹çµ„åˆ</button>
    </div>
  </dialog>

  <section class="card">
    <h2>è¨­å®šèˆ‡åŒæ­¥ï¼ˆå¯è²¼ CSV é€£çµï¼‰</h2>
    <div class="row3">
      <div>
        <label>é¡åˆ¥è¡¨ TYPE_TABLE CSV</label>
        <input id="typeCsvUrl" placeholder="https://.../TYPE_TABLE.csv" />
        <button id="btnSyncTypeCsv" class="btn-ghost">åŒæ­¥ï¼ˆé¡åˆ¥è¡¨ï¼‰</button>
      </div>
      <div>
        <label>å–®ä½æ›ç®— UNIT_MAP CSV</label>
        <input id="unitCsvUrl" placeholder="https://.../UNIT_MAP.csv" />
        <button id="btnSyncUnitCsv" class="btn-ghost">åŒæ­¥ï¼ˆå–®ä½æ›ç®—ï¼‰</button>
      </div>
      <div>
        <label>ç²¾æº–é£Ÿç‰© FOOD_DB CSV</label>
        <input id="foodCsvUrl" placeholder="https://.../FOOD_DB.csv" />
        <button id="btnSyncFoodCsv" class="btn-ghost">åŒæ­¥ï¼ˆç²¾æº–ï¼‰</button>
      </div>
    </div>
  </section>

  <footer class="card">
    <small class="muted">Â© Ju Smile æ¸›è„‚æ—¥èªŒï½œæ›´æ–°æ—¥æœŸï¼š2025-11-01</small>
  </footer>
</div>

<!-- ç‰ˆæœ¬åƒæ•¸ç¢ºä¿è¼‰åˆ°æœ€æ–° app.js -->
<script src="app.js?v=20251101-4"></script>

<!-- Service Worker è¨»å†Šï¼ˆå¸¶ç‰ˆæœ¬åƒæ•¸ï¼‹è‡ªå‹•åˆ‡æ›æ–° SWï¼‰ -->
<script>
  if ('serviceWorker' in navigator) {
    const swUrl = './service-worker.js?v=20251102-1';

    navigator.serviceWorker.register(swUrl).then(reg => {
      // è‹¥æ–° SW å·²åœ¨ waitingï¼Œè«‹å®ƒç«‹åˆ»æ¥æ‰‹
      if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });

      // åµæ¸¬æœ‰æ›´æ–°
      reg.addEventListener('updatefound', () => {
        const nw = reg.installing;
        nw && nw.addEventListener('statechange', () => {
          if (nw.state === 'installed' && navigator.serviceWorker.controller) {
            reg.waiting && reg.waiting.postMessage({ type: 'SKIP_WAITING' });
          }
        });
      });
    });

    // æ¥æ‰‹å¾Œè‡ªå‹•é‡æ–°æ•´ç†ä¸€æ¬¡
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      window.location.reload();
    });
  }
</script>
</body>
</html>
